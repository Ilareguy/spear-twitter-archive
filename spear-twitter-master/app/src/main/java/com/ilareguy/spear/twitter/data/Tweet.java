/*
Example JSON response received from Twitter's servers for a single tweet:
{
	"contributors": null,
	"coordinates": null,
	"created_at": "Wed Jun 06 20:09:03 +0000 2018",
	"display_text_range": [0, 182],
	"entities": {
		"hashtags": [{
				"indices": [86, 99],
				"text": "VAMissionAct"
			}
		],
		"media": [{
				"display_url": "pic.twitter.com\/4OsUDWIzwo",
				"expanded_url": "https://twitter.com/realDonaldTrump/status/1004455146867306496/video/1",
				"id": 1004454769350586368,
				"id_str": "1004454769350586368",
				"indices": [183, 206],
				"media_url": "http:\/\/pbs.twimg.com\/ext_tw_video_thumb\/1004454769350586368\/pu\/img\/OGMZmAswA0Lpdqyy.jpg",
				"media_url_https": "https:\/\/pbs.twimg.com\/ext_tw_video_thumb\/1004454769350586368\/pu\/img\/OGMZmAswA0Lpdqyy.jpg",
				"sizes": {
					"large": {
						"h": 720,
						"resize": "fit",
						"w": 1280
					},
					"medium": {
						"h": 675,
						"resize": "fit",
						"w": 1200
					},
					"small": {
						"h": 383,
						"resize": "fit",
						"w": 680
					},
					"thumb": {
						"h": 150,
						"resize": "crop",
						"w": 150
					}
				},
				"type": "photo",
				"url": "https:\/\/t.co\/4OsUDWIzwo"
			}
		],
		"symbols": [],
		"urls": [{
				"display_url": "45.wh.gov\/dyWJNq",
				"expanded_url": "http:\/\/45.wh.gov\/dyWJNq",
				"indices": [159, 182],
				"url": "https:\/\/t.co\/VV3GdDISbD"
			}
		],
		"user_mentions": []
	},
	"extended_entities": {
		"media": [{
				"additional_media_info": {
					"monetizable": false
				},
				"display_url": "pic.twitter.com\/4OsUDWIzwo",
				"expanded_url": "https:\/\/twitter.com\/realDonaldTrump\/status\/1004455146867306496\/video\/1",
				"id": 1004454769350586368,
				"id_str": "1004454769350586368",
				"indices": [183, 206],
				"media_url": "http:\/\/pbs.twimg.com\/ext_tw_video_thumb\/1004454769350586368\/pu\/img\/OGMZmAswA0Lpdqyy.jpg",
				"media_url_https": "https:\/\/pbs.twimg.com\/ext_tw_video_thumb\/1004454769350586368\/pu\/img\/OGMZmAswA0Lpdqyy.jpg",
				"sizes": {
					"large": {
						"h": 720,
						"resize": "fit",
						"w": 1280
					},
					"medium": {
						"h": 675,
						"resize": "fit",
						"w": 1200
					},
					"small": {
						"h": 383,
						"resize": "fit",
						"w": 680
					},
					"thumb": {
						"h": 150,
						"resize": "crop",
						"w": 150
					}
				},
				"type": "video",
				"url": "https:\/\/t.co\/4OsUDWIzwo",
				"video_info": {
					"aspect_ratio": [16, 9],
					"duration_millis": 52500,
					"variants": [{
							"bitrate": 832000,
							"content_type": "video\/mp4",
							"url": "https:\/\/video.twimg.com\/ext_tw_video\/1004454769350586368\/pu\/vid\/640x360\/KI0jPYtnOvatUkAa.mp4?tag=3"
						}, {
							"content_type": "application\/x-mpegURL",
							"url": "https:\/\/video.twimg.com\/ext_tw_video\/1004454769350586368\/pu\/pl\/R8h1Yk5PR79c9mZk.m3u8?tag=3"
						}, {
							"bitrate": 2176000,
							"content_type": "video\/mp4",
							"url": "https:\/\/video.twimg.com\/ext_tw_video\/1004454769350586368\/pu\/vid\/1280x720\/CwLgkGJEAEsV7rSo.mp4?tag=3"
						}, {
							"bitrate": 256000,
							"content_type": "video\/mp4",
							"url": "https:\/\/video.twimg.com\/ext_tw_video\/1004454769350586368\/pu\/vid\/320x180\/d1CzpuKNzlWvWqF4.mp4?tag=3"
						}
					]
				}
			}
		]
	},
	"favorite_count": 14887,
	"favorited": false,
	"full_text": "We must always protect those who protect us. Today, it was my great honor to sign the #VAMissionAct and to make Veterans Choice the permanent law of the land! https:\/\/t.co\/VV3GdDISbD https:\/\/t.co\/4OsUDWIzwo",
	"geo": null,
	"id": 1004455146867306496,
	"id_str": "1004455146867306496",
	"in_reply_to_screen_name": null,
	"in_reply_to_status_id": null,
	"in_reply_to_status_id_str": null,
	"in_reply_to_user_id": null,
	"in_reply_to_user_id_str": null,
	"is_quote_status": false,
	"lang": "en",
	"place": null,
	"possibly_sensitive": false,
	"possibly_sensitive_appealable": false,
	"retweet_count": 3798,
	"retweeted": false,
	"source": "\u003ca href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\"\u003eTwitter for iPhone\u003c\/a\u003e",
	"truncated": false,
	"user": {
		"contributors_enabled": false,
		"created_at": "Wed Mar 18 13:46:38 +0000 2009",
		"default_profile": false,
		"default_profile_image": false,
		"description": "45th President of the United States of America\ud83c\uddfa\ud83c\uddf8",
		"entities": {
			"description": {
				"urls": []
			},
			"url": {
				"urls": [{
						"display_url": "Instagram.com\/realDonaldTrump",
						"expanded_url": "http:\/\/www.Instagram.com\/realDonaldTrump",
						"indices": [0, 23],
						"url": "https:\/\/t.co\/OMxB0x7xC5"
					}
				]
			}
		},
		"favourites_count": 25,
		"follow_request_sent": false,
		"followers_count": 52487915,
		"following": true,
		"friends_count": 46,
		"geo_enabled": true,
		"has_extended_profile": false,
		"id": 25073877,
		"id_str": "25073877",
		"is_translation_enabled": true,
		"is_translator": false,
		"lang": "en",
		"listed_count": 88879,
		"location": "Washington, DC",
		"name": "Donald J. Trump",
		"notifications": false,
		"profile_background_color": "6D5C18",
		"profile_background_image_url": "http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png",
		"profile_background_image_url_https": "https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png",
		"profile_background_tile": true,
		"profile_banner_url": "https:\/\/pbs.twimg.com\/profile_banners\/25073877\/1528233931",
		"profile_image_url": "http:\/\/pbs.twimg.com\/profile_images\/874276197357596672\/kUuht00m_normal.jpg",
		"profile_image_url_https": "https:\/\/pbs.twimg.com\/profile_images\/874276197357596672\/kUuht00m_normal.jpg",
		"profile_link_color": "1B95E0",
		"profile_sidebar_border_color": "BDDCAD",
		"profile_sidebar_fill_color": "C5CEC0",
		"profile_text_color": "333333",
		"profile_use_background_image": true,
		"protected": false,
		"screen_name": "realDonaldTrump",
		"statuses_count": 37772,
		"time_zone": null,
		"translator_type": "regular",
		"url": "https:\/\/t.co\/OMxB0x7xC5",
		"utc_offset": null,
		"verified": true
	}
}

*/

package com.ilareguy.spear.twitter.data;

import com.bluelinelabs.logansquare.annotation.JsonField;
import com.bluelinelabs.logansquare.annotation.JsonObject;
import com.bluelinelabs.logansquare.annotation.OnJsonParseComplete;
import com.bluelinelabs.logansquare.typeconverters.StringBasedTypeConverter;
import com.ilareguy.spear.twitter.MediaType;
import com.ilareguy.spear.twitter.TwitterApplication;
import com.ilareguy.spear.util.DiffCallback;
import com.ilareguy.spear.util.Timestamp;
import com.twitter.twittertext.Extractor;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.room.ColumnInfo;
import androidx.room.Entity;
import androidx.room.Ignore;
import androidx.room.Index;
import androidx.room.PrimaryKey;
import androidx.room.TypeConverter;

@Entity(indices = {@Index("author_id"), @Index("in_reply_to_status_id")})
@JsonObject
public class Tweet implements DiffCallback<Tweet>{

    @JsonObject
    public static class Entities {

        public static final class ExtractedEntity extends TweetEntityAbstract
                implements Serializable {
            public final String value;
            public final TweetEntityAbstract.Type type;

            public TweetEntityAbstract.Type getType(){ return type; }

            public ExtractedEntity(Extractor.Entity extracted_entity){
                super(extracted_entity);
                value = extracted_entity.getValue();

                switch(extracted_entity.getType()){
                    case CASHTAG:
                        type = TweetEntityAbstract.Type.CASHTAG;
                        break;
                    case HASHTAG:
                        type = TweetEntityAbstract.Type.HASHTAG;
                        break;
                    default:
                        type = TweetEntityAbstract.Type.MENTION;
                        break;
                }
            }
        }

        @JsonObject
        public static final class UrlEntity extends TweetEntityAbstract
                implements Serializable {
            @Override
            public TweetEntityAbstract.Type getType(){ return TweetEntityAbstract.Type.URL; }

            @JsonField(name = "url")
            public @NonNull String minifiedUrl; // Of the https://t.co/ sort

            @JsonField(name = "display_url")
            public String displayUrl; // The text to display in the tweet contents

            @JsonField(name = "expanded_url")
            public String expandedUrl;

            public UrlEntity(){ super(); }
            public UrlEntity(Extractor.Entity extracted_entity){
                super(extracted_entity);
                minifiedUrl = extracted_entity.getValue();
                expandedUrl = minifiedUrl;
                displayUrl = minifiedUrl;
            }
        }

        @JsonObject
        public static final class MediaEntity extends TweetEntityAbstract
                implements Serializable {

            @JsonObject
            public static final class Sizes implements Serializable {
                @JsonObject
                public static final class Data implements Serializable {
                    @JsonField(name = "w")
                    public int width;
                    @JsonField(name = "h")
                    public int height;
                    @JsonField(name = "resize")
                    public String resizeType;
                }

                @JsonField(name = "large")
                public Data large;
                @JsonField(name = "medium")
                public Data medium;
                @JsonField(name = "small")
                public Data small;
                @JsonField(name = "thumb")
                public Data thumb;
            }

            @JsonObject
            public static final class VideoData implements Serializable {
                @JsonObject
                public static final class Variant implements Serializable {
                    @JsonField(name = "bitrate")
                    public int bitrate;
                    @JsonField(name = "content_type")
                    public String content_type;
                    @JsonField(name = "url")
                    public String url;
                }

                @JsonField(name = "aspect_ratio")
                public int[] aspectRatio;
                @JsonField(name = "duration_millis")
                public int duration_ms;
                @JsonField(name = "variants")
                public List<Variant> variants;
            }

            @Override
            public TweetEntityAbstract.Type getType(){ return TweetEntityAbstract.Type.MEDIA; }
            @JsonField(name = "id")
            public long id;
            @JsonField(name = "display_url")
            public String displayUrl;
            @JsonField(name = "media_url_https")
            public String mediaUrl;
            // Type of uploaded media. Possible types include photo, video, and animated_gif
            @JsonField(name = "type", typeConverter = MediaTypeConverter.class)
            public MediaType mediaType;
            @JsonField(name = "sizes")
            public Sizes sizes;
            @JsonField(name = "video_info")
            public @Nullable VideoData videoData = null;

            public static final class MediaTypeConverter extends StringBasedTypeConverter<MediaType>{
                @Override
                public MediaType getFromString(String s) {
                    return MediaType.valueOf(s.toUpperCase());
                }

                @Override
                public String convertToString(MediaType t){
                    return t.name();
                }
            }
        }

        @JsonField(name = "urls")
        private List<UrlEntity> urls = new ArrayList<>();
        private List<MediaEntity> medias = new ArrayList<>();
        private List<ExtractedEntity> extractedEntities = new ArrayList<>();

        public void addExtractedEntities(List<Extractor.Entity> extracted_entities){
            for(Extractor.Entity extracted_entity : extracted_entities){
                extractedEntities.add(new ExtractedEntity(extracted_entity));
            }
        }

        public void addUrlEntities(List<Extractor.Entity> urls){
            for(Extractor.Entity entity : urls){
                this.urls.add(new UrlEntity(entity));
            }
        }



        public List<UrlEntity> getUrls(){
            return urls;
        }

        public void setUrls(@Nullable List<UrlEntity> urls){
            if(urls != null)
                this.urls = urls;
            else
                this.urls.clear();
        }

        public List<MediaEntity> getMedias(){
            return medias;
        }

        public void setMedias(@Nullable List<MediaEntity> medias){
            if(medias != null)
                this.medias = medias;
            else
                this.medias.clear();
        }

        public List<ExtractedEntity> getExtractedEntities(){
            return extractedEntities;
        }

        public void setExtractedEntities(List<ExtractedEntity> extractedEntities){
            this.extractedEntities = extractedEntities;
        }
    }

    // Needed to extract media data...
    @JsonObject
    public static class ExtendedEntities{
        @JsonField(name = "media")
        private List<Entities.MediaEntity> medias = new ArrayList<>();

        public List<Entities.MediaEntity> getMedias(){
            return medias;
        }

        public void setMedias(List<Entities.MediaEntity> medias){
            this.medias = medias;
        }
    }

    @PrimaryKey
    @JsonField(name = "id")
    private long id;

    @JsonField(name = "created_at")
    @ColumnInfo(name = "created_at")
    private String createdAt;

    @JsonField(name = "full_text")
    private String text;

    @JsonField(name = "text")
    @Ignore
    private String trimmedText;

    @JsonField(name = "retweet_count")
    @ColumnInfo(name = "retweet_count")
    private int retweetCount;

    @JsonField(name = "favorite_count")
    @ColumnInfo(name = "favorite_count")
    private int favoriteCount;

    @JsonField(name = "possibly_sensitive")
    @ColumnInfo(name = "possibly_sensitive")
    private boolean possiblySensitive;

    @JsonField(name = "author_id")
    @ColumnInfo(name = "author_id")
    private long authorId;

    @ColumnInfo(name = "cached_timestamp")
    private long cachedTimestamp;

    @ColumnInfo(name = "quoted_tweet_id")
    private long quotedTweetId;

    @ColumnInfo(name = "retweeted_tweet_id")
    private long retweetedTweetId;

    @Ignore
    @JsonField(name = "retweeted_status")
    private Tweet retweetedTweet;

    @Ignore
    @JsonField(name = "quoted_status")
    private Tweet quotedTweet;

    @Ignore
    @JsonField(name = "user")
    private User author = null;

    @Ignore
    private @Nullable Tweet parentTweet = null;

    @JsonField(name = "in_reply_to_status_id")
    @ColumnInfo(name = "in_reply_to_status_id")
    private @Nullable long inReplyToTweetId;

    @JsonField(name = "in_reply_to_user_id")
    @ColumnInfo(name = "in_reply_to_user_id")
    private @Nullable long inReplyToUserId;

    @JsonField(name = "in_reply_to_screen_name")
    @ColumnInfo(name = "in_reply_to_screen_name")
    private @Nullable String inReplyToScreenName;

    @JsonField(name = "lang")
    @ColumnInfo(name = "lang")
    private String languageCode;

    /**
     * Currently this data is only valid when the Tweet is loaded remotely!
     */
    @JsonField(name = "favorited")
    @Ignore
    private boolean liked;

    /**
     * Currently this data is only valid when the Tweet is loaded remotely!
     */
    @JsonField(name = "retweeted")
    @Ignore
    private boolean retweeted;

    @Ignore
    @JsonField(name = "entities")
    private Entities entities = new Entities();

    @Ignore
    @JsonField(name = "extended_entities")
    private ExtendedEntities extendedEntities = new ExtendedEntities();

    @Ignore
    private @Nullable List<Tweet> replies = null;

    /*
     * "an array of two unicode code point indices, identifying the inclusive start and exclusive
     * end of the displayable content of the Tweet."
     * See https://developer.twitter.com/en/docs/tweets/tweet-updates.html
     */
    @Ignore
    @JsonField(name = "display_text_range")
    private int[] displayTextRange;

    @ColumnInfo(name = "urls", typeAffinity = ColumnInfo.BLOB)
    protected @Nullable List<Entities.UrlEntity> urls = null;

    @ColumnInfo(name = "medias", typeAffinity = ColumnInfo.BLOB)
    protected @Nullable List<Entities.MediaEntity> medias = null;

    public Tweet() {}

    @OnJsonParseComplete
    void onParseComplete() {
        entities.medias = extendedEntities.medias;
        extendedEntities.medias = null;
        retweetedTweetId = ((retweetedTweet == null) ? 0 : retweetedTweet.getId());
        quotedTweetId = ((quotedTweet == null) ? 0 : quotedTweet.getId());

        processText();
        processUrls();
        parseEntities();
    }

    /**
     * When you read an Tweet from the cache, call this method once.
     */
    public void onPostReadFromCache(final long authenticating_user_id){
        onPostReadFromCache(authenticating_user_id, false); }
    public void onPostReadFromCache(final long authenticating_user_id, boolean load_parent_tweet){
        parseEntities();
        loadContainedTweetFromCache(authenticating_user_id);
        loadAuthorFromCache();
        loadInteractionsFromCache(authenticating_user_id);
        if(load_parent_tweet) loadParentTweetFromCache(authenticating_user_id);

        entities.setMedias(medias);
        entities.setUrls(urls);
        urls = null;
        medias = null;
    }

    private void loadParentTweetFromCache(final long authenticating_user_id){
        if(inReplyToTweetId == 0) return;
        parentTweet = TwitterApplication.getTwitterInstance().getCacheDatabase().tweetDao().get(inReplyToTweetId);
        if(parentTweet != null)
            parentTweet.onPostReadFromCache(authenticating_user_id, false);
    }

    /**
     * Call this only when the Tweet object was built from JSON.
     */
    private void processText(){
        if(text == null || text.length() == 0){
            // When posting a tweet, Twitter returns the "text" JSON field even if it's not trimmed...
            text = trimmedText;
        }else{
            // Trim the original contents received from Twitter
            text = text.substring(0, text.offsetByCodePoints(0, displayTextRange[1]));
        }

        // Transform HTML characters (for some reason Twitter sends those)
        text = org.apache.commons.text.StringEscapeUtils.unescapeHtml4(text);
    }

    /**
     * Call this only when the Tweet object was built from JSON.
     * Removes unneeded URLs.
     */
    private void processUrls(){
        // Strip quoted tweet URL
        if(quotedTweetId > 0){
            if(entities.urls.size() > 0 &&
                    entities.urls.get(entities.urls.size() - 1)
                    .expandedUrl.endsWith("/status/" + String.valueOf(quotedTweetId))){
                // Match! Remove that bastard.
                entities.urls.remove(entities.urls.size() - 1);
            }
        }

        // Replace minified URLs
        for(Entities.UrlEntity entity : entities.urls){
            // Find the starting index for this URL
            entity.indexStart = text.indexOf(entity.minifiedUrl);
            // Replace text
            text = text.replace(entity.minifiedUrl, entity.displayUrl);
            // Find the last index for this URL
            entity.indexEnd = entity.indexStart + entity.displayUrl.length();
        }
    }

    /**
     * Parses mentions, hashtags and cashtags from the tweet's contents.
     */
    private void parseEntities() {
        // See: https://github.com/twitter/twitter-text/tree/master/java
        entities.addExtractedEntities(TweetEntityAbstract.entitiesExtractor.extractCashtagsWithIndices(getText()));
        entities.addExtractedEntities(TweetEntityAbstract.entitiesExtractor.extractHashtagsWithIndices(getText()));
        entities.addExtractedEntities(TweetEntityAbstract.entitiesExtractor.extractMentionedScreennamesWithIndices(getText()));
    }

    /**
     * If this is a retweet, then this will load retweeted tweet from the cache.
     * Alternatively, the same is done for a quoted tweet if this tweet quotes another one.
     * It is only necessary to invoke this method when you're loading a tweet from the cache, and not
     * when this object is created from a JSON parsing operation.
     */
    private void loadContainedTweetFromCache(final long authenticating_user_id) {
        if (retweetedTweetId > 0) {
            retweetedTweet = TwitterApplication.getTwitterInstance().getCacheDatabase().tweetDao().get(retweetedTweetId);
            if(retweetedTweet == null) return;
            retweetedTweet.onPostReadFromCache(authenticating_user_id);
        } else if (quotedTweetId > 0) {
            quotedTweet = TwitterApplication.getTwitterInstance().getCacheDatabase().tweetDao().get(quotedTweetId);
            if(quotedTweet == null) return;
            quotedTweet.onPostReadFromCache(authenticating_user_id);
        }
    }

    private void loadAuthorFromCache() {
        if(authorId > 0)
            author = TwitterApplication.getTwitterInstance().getCacheDatabase().userDao().getMinimum(authorId);
    }

    private void loadInteractionsFromCache(final long authenticating_user_id){
        if(authenticating_user_id > 0){
            final UserTweetInteraction interaction = TwitterApplication.getTwitterInstance()
                    .getCacheDatabase().tweetInteractionDao().get(authenticating_user_id, id);
            if(interaction == null) return;

            this.liked = interaction.isLiked();
            this.retweeted = interaction.isRetweeted();
        }
    }

    public void cache() {
        cache(0);
    }

    public void cache(long authenticating_user_id /* user that performed the OAuth request */) {
        onCacheBegin();

        // Set cache timestamp
        cachedTimestamp = Timestamp.now();

        // Save
        TwitterApplication.getTwitterInstance().getCacheDatabase().tweetDao().save(this);

        // Save author
        //if(author != null) author.cache();
        // Don't! We may be saving hundreds of tweets with the same author!

        if (authenticating_user_id > 0) {
            // Save whether or not the authenticated user is following them
            final Relationship new_relationship = new Relationship();
            new_relationship.setSourceId(authenticating_user_id);
            new_relationship.setTargetId(getAuthorId());
            new_relationship.setFollowingTarget(getAuthor().getFollowing());

            // These two could be wrong, but getting the actual values would require another call to
            // Twitter's servers, so just assume these values for now.
            new_relationship.setFollowedByTarget(false);
            new_relationship.setCanMessageTarget(true);

            // Cache the new relationship data
            new_relationship.cache();

            // Save interactions
            TwitterApplication.getTwitterInstance().getCacheDatabase().tweetInteractionDao()
                    .save(new UserTweetInteraction(
                            authenticating_user_id,
                            id,
                            liked,
                            retweeted,
                            false,
                            false
                    ));
        }

        // Save the contained tweets
        if (quotedTweet != null) {
            quotedTweet.cache();
            quotedTweet.getAuthor().cache();
        } else if (retweetedTweet != null) {
            retweetedTweet.cache();
            retweetedTweet.getAuthor().cache();
        }

        onCacheFinish();
    }

    private void onCacheBegin(){
        urls = entities.urls;
        medias = entities.medias;
    }

    private void onCacheFinish(){
        // Clean serialized data. Thanks Java for not letting me free memory directly.
        urls = null;
        medias = null;
    }



    public boolean isRetweet() {
        return (retweetedTweetId > 0 && retweetedTweet != null);
    }

    public boolean isQuote() {
        return (quotedTweetId > 0 && quotedTweet != null);
    }


    public String getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(String createdAt) {
        this.createdAt = createdAt;
    }

    public String getText() {
        return text;
    }

    public void setText(String t) {
        this.text = t;
    }

    public String getTrimmedText(){
        return trimmedText;
    }

    public void setTrimmedText(String trimmedText){
        this.trimmedText = trimmedText;
    }

    public int getRetweetCount() {
        return retweetCount;
    }

    public void setRetweetCount(int retweetCount) {
        this.retweetCount = retweetCount;
    }

    public boolean isPossiblySensitive() {
        return possiblySensitive;
    }

    public void setPossiblySensitive(boolean possiblySensitive) {
        this.possiblySensitive = possiblySensitive;
    }

    public long getAuthorId() {
        return authorId;
    }

    public void setAuthorId(long authorId) {
        this.authorId = authorId;
    }

    public long getCachedTimestamp() {
        return cachedTimestamp;
    }

    public void setCachedTimestamp(long cachedTimestamp) {
        this.cachedTimestamp = cachedTimestamp;
    }

    public User getAuthor() {
        return author;
    }

    public void setAuthor(User author) {
        this.author = author;
        setAuthorId((this.author != null) ? this.author.getUid() : 0);
    }

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public long getQuotedTweetId() {
        return quotedTweetId;
    }

    public void setQuotedTweetId(long quotedTweetId) {
        this.quotedTweetId = quotedTweetId;
    }

    public long getRetweetedTweetId() {
        return retweetedTweetId;
    }

    public void setRetweetedTweetId(long retweetedTweetId) {
        this.retweetedTweetId = retweetedTweetId;
    }

    public Tweet getRetweetedTweet() {
        return retweetedTweet;
    }

    public void setRetweetedTweet(Tweet retweetedTweet) {
        this.retweetedTweet = retweetedTweet;
    }

    public Tweet getQuotedTweet() {
        return quotedTweet;
    }

    public void setQuotedTweet(Tweet quotedTweet) {
        this.quotedTweet = quotedTweet;
    }

    public int getFavoriteCount() {
        return favoriteCount;
    }

    public void setFavoriteCount(int favoriteCount) {
        this.favoriteCount = favoriteCount;
    }

    public long getInReplyToTweetId() {
        return inReplyToTweetId;
    }

    public void setInReplyToTweetId(long inReplyToTweetId) {
        this.inReplyToTweetId = inReplyToTweetId;
    }

    public long getInReplyToUserId() {
        return inReplyToUserId;
    }

    public void setInReplyToUserId(long inReplyToUserId) {
        this.inReplyToUserId = inReplyToUserId;
    }

    public String getInReplyToScreenName() {
        return inReplyToScreenName;
    }

    public void setInReplyToScreenName(String inReplyToScreenName) {
        this.inReplyToScreenName = inReplyToScreenName;
    }

    public String getLanguageCode() {
        return languageCode;
    }

    public void setLanguageCode(String languageCode) {
        this.languageCode = languageCode;
    }

    public boolean isLiked(){
        return liked;
    }

    public void setLiked(boolean liked){
        this.liked = liked;
    }

    public boolean isRetweeted(){
        return retweeted;
    }

    public void setRetweeted(boolean retweeted){
        this.retweeted = retweeted;
    }

    public List<Tweet> getReplies() {
        return replies;
    }

    public void setReplies(List<Tweet> replies) {
        this.replies = replies;
    }

    public Entities getEntities(){
        return entities;
    }

    public void setEntities(Entities entities){
        this.entities = entities;
    }

    public int[] getDisplayTextRange(){
        return displayTextRange;
    }

    public void setDisplayTextRange(int[] displayTextRange){
        this.displayTextRange = displayTextRange;
    }

    public ExtendedEntities getExtendedEntities(){
        return extendedEntities;
    }

    public void setExtendedEntities(ExtendedEntities extendedEntities){
        this.extendedEntities = extendedEntities;
    }

    public Tweet getParentTweet(){
        return parentTweet;
    }

    public void setParentTweet(Tweet parentTweet){
        this.parentTweet = parentTweet;
    }

    @Override
    public boolean equals(Object o){
        if(this == o) return true;
        if(!(o instanceof Tweet)) return false;
        Tweet tweet = (Tweet) o;
        return id == tweet.id &&
                retweetCount == tweet.retweetCount &&
                favoriteCount == tweet.favoriteCount &&
                possiblySensitive == tweet.possiblySensitive &&
                authorId == tweet.authorId &&
                cachedTimestamp == tweet.cachedTimestamp &&
                quotedTweetId == tweet.quotedTweetId &&
                retweetedTweetId == tweet.retweetedTweetId &&
                inReplyToTweetId == tweet.inReplyToTweetId &&
                inReplyToUserId == tweet.inReplyToUserId &&
                Objects.equals(text, tweet.text);
    }

    @Override
    public boolean isSame(@NonNull Tweet newObject){ return getId() == newObject.getId(); }
    @Override
    public boolean isContentsSame(@NonNull Tweet newObject){ return equals(newObject); }

    public static abstract class Converters{
        @TypeConverter
        public static @Nullable byte[] fromUrlEntities(@Nullable List<Entities.UrlEntity> entities){
            if(entities == null || entities.size() == 0)
                return null;
            try{
                ByteArrayOutputStream bos = new ByteArrayOutputStream();
                ObjectOutputStream oos = new ObjectOutputStream(bos);
                oos.writeObject(entities);
                return bos.toByteArray();
            }catch(IOException e){
                return null;
            }
        }

        @TypeConverter
        public static @Nullable List<Entities.UrlEntity> toUrlEntities(@Nullable byte[] data){
            if(data == null)
                return null;
            try{
                ByteArrayInputStream bis = new ByteArrayInputStream(data);
                ObjectInputStream ois = new ObjectInputStream(bis);
                return (List<Entities.UrlEntity>) ois.readObject();
            }catch(IOException | ClassNotFoundException e){
                return null;
            }
        }

        @TypeConverter
        public static @Nullable byte[] fromMediaEntities(@Nullable List<Entities.MediaEntity> entities){
            if(entities == null || entities.size() == 0)
                return null;
            try{
                ByteArrayOutputStream bos = new ByteArrayOutputStream();
                ObjectOutputStream oos = new ObjectOutputStream(bos);
                oos.writeObject(entities);
                return bos.toByteArray();
            }catch(IOException e){
                return null;
            }
        }

        @TypeConverter
        public static @Nullable List<Entities.MediaEntity> toMediaEntities(@Nullable byte[] data){
            if(data == null)
                return null;
            try{
                ByteArrayInputStream bis = new ByteArrayInputStream(data);
                ObjectInputStream ois = new ObjectInputStream(bis);
                return (List<Entities.MediaEntity>) ois.readObject();
            }catch(IOException | ClassNotFoundException e){
                return null;
            }
        }
    }
}
